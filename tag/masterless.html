<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>GTmanfred - masterless</title>
        <link rel="stylesheet" href="https://blog.gtmanfred.com/theme/css/main.css" />
        <link href="https://blog.gtmanfred.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="GTmanfred Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.gtmanfred.com/">GTmanfred </a></h1>
                <nav><ul>
    
                        <li><a href="https://blog.gtmanfred.com/pages/about.html">About</a></li>
                    <li><a href="https://blog.gtmanfred.com/category/pelican.html">Pelican</a></li>
                    <li><a href="https://blog.gtmanfred.com/category/salt.html">Salt</a></li>
                    <li><a href="https://blog.gtmanfred.com/category/zsh.html">Zsh</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://blog.gtmanfred.com/masterless-reactor.html">Using webhooks and the reactor with masterless minions</a></h1>
<footer class="post-info">
        <span>Fri 14 October 2016</span>
<span>| tags: <a href="https://blog.gtmanfred.com/tag/salt.html">salt</a><a href="https://blog.gtmanfred.com/tag/masterless.html">masterless</a><a href="https://blog.gtmanfred.com/tag/webhooks.html">webhooks</a><a href="https://blog.gtmanfred.com/tag/github.html">github</a></span>
</footer><!-- /.post-info --><h1>Getting Started</h1>
<p>This requires at least the 2016.11.0 release of saltstack.</p>
<p>http://repo.saltstack.com/</p>
<p>Then just <code>yum install -y salt-minion</code></p>
<h1>Modules from Nitrogen</h1>
<p>You will also need a few new modules and a new engine that will be in the Nitrogen release.</p>
<p>In <code>/srv/salt/_modules</code> you will need the following two modules: <a href="https://github.com/gtmanfred/salt/blob/hashutil/salt/modules/hashutil.py">new hashutil module</a> and <a href="https://github.com/gtmanfred/salt/blob/event_send/salt/modules/event.py">new event module</a></p>
<p>And the thing that makes it all possible the new webhook engine needs to be put in <code>/srv/salt/_engines</code>: <a href="https://github.com/gtmanfred/salt/blob/webhook/salt/engines/webhook.py">Webhook engine</a></p>
<p>Once these are all in place, run <code>salt-call saltutil.sync_all</code> to make sure they get put in the extmods directory and are usable.</p>
<h1>Configuration</h1>
<p>My configurations are located <a href="https://github.com/gtmanfred/blog-sls">here</a> but I will highlight some of the specifics here.</p>
<p>First, we want to make the minion a masterless minion, and to never query the master for anything.  So to <code>/etc/salt/minion.d/local.conf</code> add</p>
<div class="highlight"><pre><span></span><span class="n">local</span><span class="o">:</span> <span class="n">True</span>
<span class="n">file_client</span><span class="o">:</span> <span class="n">local</span>
<span class="n">master_type</span><span class="o">:</span> <span class="n">disable</span>
</pre></div>


<p>Any one of the settings could be used, I like to use all three just to make certain.</p>
<p>Second, we need to setup the ssl keys so that we can have a secure connection.  To do this, you can run the following command to create a generic ssl certificate, if you want to have verification in there, you can make a nice one for the domain and everything, but we just want to have the traffice encrypted, so use <code>salt-call --local tls.create_self_signed_cert</code>.  Now that we have an ssl certificate pair, we can setup the webhook engine.  I put the following in <code>/etc/salt/minion.d/engines.conf</code>.</p>
<div class="highlight"><pre><span></span>engines:
  - webhook:
      address: None
      port: 5000
      ssl_crt: /etc/pki/tls/certs/localhost.crt
      ssl_key: /etc/pki/tls/certs/localhost.key
  - reactor: {}

reactor:
  - &#39;salt/engines/hook/update/blog/gtmanfred.com&#39;:
    - salt://reactor/blog.gtmanfred.com.sls
</pre></div>


<p>This will enable the webhook on all ips on port 5000 with the listed ssl certificate.  It will also enable the reactor to be able to act upon the one tag in the event stream, which we will get to later.</p>
<p>Now we need to setup the github webhook so we can see the events in the event stream.  Go to your blog's github repository, and go to the settings.  Then select webhooks, and create a new one.</p>
<p><img alt="Configure Github" src="https://blog.gtmanfred.com/images/blog.png"></p>
<p>For the "Payload URL" you are going to set https and then the ip address/domain and port to access, followed by the uri which should match what your are going to trigger on for the reactor.  As you can see in the picture above, I have <code>/update/blog/gtmanfred.com</code> as my URI, and this matches what follows the prefix <code>salt/engines/hook</code> in the reactor config above.  Be sure to add a secret! And don't forget it! We will be verifying that in a later step.  Then customize which events you would like to trigger on and save. I am going to rebuild the blog on each push, so I am only sending push events.</p>
<p>BE SURE TO DISABLE SSL VERIFICATION IF YOU DON'T USE A SIGNED KEY!</p>
<p>Before you forget that secret key, we should save it somewhere.  I use sdb in salt so that I can save my states and reactors in public github, but hide the secret key in sdb.  Create <code>/etc/salt/minion.d/sdb.conf</code> with the following.</p>
<div class="highlight"><pre><span></span><span class="n">secrets</span><span class="o">:</span>
  <span class="n">driver</span><span class="o">:</span> <span class="n">sqlite3</span>
  <span class="n">database</span><span class="o">:</span> <span class="sr">/var/lib/s</span><span class="n">db</span><span class="o">.</span><span class="na">sqlite</span>
  <span class="n">table</span><span class="o">:</span> <span class="n">sdb</span>
  <span class="n">create_table</span><span class="o">:</span> <span class="n">True</span>
</pre></div>


<p>Now run <code>salt-call --local sdb.set sdb://secrets/github_secret &lt;secretkey&gt;</code> to save the key.</p>
<p>Now the last step, creating the reactor file in the salt fileserver.  Mine is in /srv/salt/reactor/blog.gtmanfred.com.sls, so I just have to reference it with salt://reactor/blog.gtmanfred.com.sls (and can also use the reactor files from gitfs).</p>
<div class="highlight"><pre><span></span>{%- if salt.hashutil.github_signature(data[&#39;body&#39;], salt.sdb.get(&#39;sdb://secrets/github_secret&#39;), data[&#39;headers&#39;][&#39;X-Hub-Signature&#39;]) %}
highstate_run:
  caller.state.apply:
    - args: []
{%- endif %}
</pre></div>


<p>Lets walk through this.  We are going to take the <code>data['body']</code> from the github post, and our secret, and the <code>X-Hub-Signature</code> and run it through the github_signature function to verify if the signature is the result of signing the body with your secret key.  If True comes back, we can be sure this came from github, and then our minion runs a highstate on itself.  If it is False, nothing is rendered and no event is run.</p><p><a href="https://blog.gtmanfred.com/masterless-reactor.html#disqus_thread">comments</a></p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="https://github.com/gtmanfred/">Git Repositories</a></li>
                            <li><a href="/feeds/">Feeds</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.gtmanfred.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42514099-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'gtmanfred';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>